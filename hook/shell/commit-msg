#!/bin/bash

prefixRegExp=(^[A-Z]+-[0-9]+).*

messageFile=$1
originalMessage=`cat $messageFile`

if [[ -z "$originalMessage" ]]; then
  exit 0  # let Git reject it
elif [[ "$originalMessage" =~ ^(fixup|squash)! ]]; then
  echo 'commit-msg: fixup or squash commit; no action'
  exit 0
fi

branchName=`git symbolic-ref --short -q HEAD`

if [[ "$branchName" =~ $prefixRegExp ]]; then
  : # $BASH_REMATCH is branchPrefixMatch
else
  echo 'commit-msg: on non-prefixed branch; no action'
  exit 0
fi

desiredPrefix="${BASH_REMATCH[1]}"

if [[ "$originalMessage" =~ $prefixRegExp ]]; then
  # $BASH_REMATCH is originalPrefixMatch

  if [ "${BASH_REMATCH[1]}" = "$desiredPrefix" ]; then
    echo 'commit-msg: message already prefixed correctly; no action'
  else
    echo "commit-msg: message prefix '${BASH_REMATCH[1]}' does not match branch prefix '${desiredPrefix}'"
    exit 1
  fi
else
  echo "$desiredPrefix $originalMessage" > $messageFile
fi
